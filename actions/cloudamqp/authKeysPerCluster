var lib = require("cloudamqp/cloudamqpLib");
var config = require("cloudamqp/config").getConfig();
var authorization = lib.buildAmqpApiAuthorization(config.username, config.password);

var vhosts = lib.amqpApi(config.baseUrl, "vhosts", authorization);

var vhostsResult = {};

for(var i = 0; i < vhosts.length; i++) {
    var vhost = vhosts[i];
    var name = vhost.name;
    var decodedName = null;
    var authKey = null;
    var clusterName = null;
    if(name == request.parameters.username || name == "/" || name == "test") {
        decodedName = name;
        clusterName = name;
    } else {
        decodedName = atob(name);
        authKey = decodedName.split("@")[0];
        clusterName = decodedName.split("@")[1];
    }
    if(vhostsResult[clusterName] == null) {
    	vhostsResult[clusterName] = [];
        vhostsResult[clusterName + "-count"] = 0;
    }
    vhostsResult[clusterName].push(authKey);
    vhostsResult[clusterName + "-count"] = vhostsResult[clusterName + "-count"] + 1;
}

return vhostsResult;